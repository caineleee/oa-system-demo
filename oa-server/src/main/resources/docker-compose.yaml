# 服务定义
services:
  # MySQL 数据库服务
  mysql:
    # 使用的镜像
    image: mysql:8.0
    # 容器名称
    container_name: mysql-server
    # 重启策略
    restart: unless-stopped
    # 端口映射 (主机端口:容器端口)
    ports:
      - "3306:3306"
    # 网络配置
    networks:
      - redis-net
    # 环境变量配置
    environment:
      # MySQL root 用户密码
      MYSQL_ROOT_PASSWORD: root
      # 默认创建的数据库名称
      MYSQL_DATABASE: oa-sys-database
    # 数据卷挂载
    volumes:
      # 挂载 MySQL 数据目录以实现数据持久化
      - mysql-data:/var/lib/mysql
    # MySQL 启动命令参数
    command: --default-authentication-plugin=mysql_native_password
    # 健康检查配置
    healthcheck:
      # 健康检查命令
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      # 检查间隔
      interval: 30s
      # 超时时间
      timeout: 10s
      # 重试次数
      retries: 3
      start_period: 40s

  # Redis 主节点服务
  redis-master:
    # 使用的镜像
    image: redis:7-alpine
    # 容器名称
    container_name: redis-master
    # 重启策略
    restart: unless-stopped
    # 端口映射
    ports:
      - "6379:6379"
    # 网络配置
    networks:
      - redis-net
    # 数据卷挂载
    volumes:
      # 挂载 Redis 数据目录以实现数据持久化
      - redis_master_data:/data
    # Redis 启动命令参数
    command: >
      redis-server
      --port 6379
      --protected-mode no
      --daemonize no
      --dir /data
      --dbfilename dump-6379.rdb
      --logfile /data/redis-6379.log
      --appendonly yes
      --appendfilename appendonly-6379.aof
      --requirepass root
      --masterauth root
      --loglevel verbose
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      # 检查间隔
      interval: 60s
      # 超时时间
      timeout: 10s
      # 重试次数
      retries: 3
      start_period: 20s

  # Redis 从节点1服务
  redis-slave1:
    # 使用的镜像
    image: redis:7-alpine
    # 容器名称
    container_name: redis-slave1
    # 重启策略
    restart: unless-stopped
    # 端口映射
    ports:
      - "6380:6380"
    # 网络配置
    networks:
      - redis-net
    # 数据卷挂载
    volumes:
      # 挂载 Redis 数据目录以实现数据持久化
      - redis_slave1_data:/data
    # 依赖关系，确保主节点先启动
    depends_on:
      redis-master:
        condition: service_healthy
    # Redis 启动命令参数
    command: >
      redis-server
      --port 6380
      --protected-mode no
      --daemonize no
      --dir /data
      --dbfilename dump-6380.rdb
      --logfile /data/redis-6380.log
      --appendonly yes
      --appendfilename appendonly-6380.aof
      --replicaof redis-master 6379
      --requirepass root
      --masterauth root
      --loglevel verbose
    healthcheck:
      test: [ "CMD", "redis-cli", "-p", "6380", "ping" ]
      # 检查间隔
      interval: 60s
      # 超时时间
      timeout: 10s
      # 重试次数
      retries: 3
      start_period: 20s

  # Redis 从节点2服务
  redis-slave2:
    # 使用的镜像
    image: redis:7-alpine
    # 容器名称
    container_name: redis-slave2
    # 重启策略
    restart: unless-stopped
    # 端口映射
    ports:
      - "6381:6381"
    # 网络配置
    networks:
      - redis-net
    # 数据卷挂载
    volumes:
      # 挂载 Redis 数据目录以实现数据持久化
      - redis_slave2_data:/data
    # 依赖关系，确保主节点先启动
    depends_on:
      redis-master:
        condition: service_healthy
    # Redis 启动命令参数
    command: >
      redis-server
      --port 6381
      --protected-mode no
      --daemonize no
      --dir /data
      --dbfilename dump-6381.rdb
      --logfile /data/redis-6381.log
      --appendonly yes
      --appendfilename appendonly-6381.aof
      --replicaof redis-master 6379
      --requirepass root
      --masterauth root
      --loglevel verbose
    healthcheck:
      test: [ "CMD", "redis-cli", "-p", "6381", "ping" ]
      # 检查间隔
      interval: 60s
      # 超时时间
      timeout: 10s
      # 重试次数
      retries: 3
      start_period: 20s

  # Redis Sentinel 1 服务
  redis-sentinel1:
    # 使用的镜像
    image: redis:7-alpine
    # 容器名称
    container_name: redis-sentinel1
    # 重启策略
    restart: unless-stopped
    # 端口映射
    ports:
      - "26379:26379"
    # 网络配置
    networks:
      - redis-net
    # 数据卷挂载
    volumes:
      # 挂载 Sentinel 数据目录
      - sentinel1-data:/data
    # 依赖关系，确保 Redis 主节点先启动
    depends_on:
      redis-master:
          condition: service_healthy
    # Sentinel 启动命令参数
    command: >
      sh -c "
        echo 'port 26379' > /tmp/sentinel.conf &&
        echo 'dir /data' >> /tmp/sentinel.conf &&
        echo 'sentinel monitor mymaster localhost 6379 2' >> /tmp/sentinel.conf &&
        echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
        echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
        echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
        echo 'sentinel resolve-hostnames yes' >> /tmp/sentinel.conf &&
        echo 'sentinel auth-pass mymaster root' >> /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      "
    healthcheck:
      test: [ "CMD", "redis-cli", "-p", "26379", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Redis Sentinel 2 服务
  redis-sentinel2:
    # 使用的镜像
    image: redis:7-alpine
    # 容器名称
    container_name: redis-sentinel2
    # 重启策略
    restart: unless-stopped
    # 端口映射
    ports:
      - "26380:26379"
    # 网络配置
    networks:
      - redis-net
    # 数据卷挂载
    volumes:
      # 挂载 Sentinel 数据目录
      - sentinel2-data:/data
    # 依赖关系，确保 Redis 主节点先启动
    depends_on:
      redis-master:
        condition: service_healthy
    # Sentinel 启动命令参数
    command: >
      sh -c "
        echo 'port 26379' > /tmp/sentinel.conf &&
        echo 'dir /data' >> /tmp/sentinel.conf &&
        echo 'sentinel monitor mymaster localhost 6379 2' >> /tmp/sentinel.conf &&
        echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
        echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
        echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
        echo 'sentinel resolve-hostnames yes' >> /tmp/sentinel.conf &&
        echo 'sentinel auth-pass mymaster root' >> /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      "
    healthcheck:
      test: [ "CMD", "redis-cli", "-p", "26379", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Redis Sentinel 3 服务
  redis-sentinel3:
    # 使用的镜像
    image: redis:7-alpine
    # 容器名称
    container_name: redis-sentinel3
    # 重启策略
    restart: unless-stopped
    # 端口映射
    ports:
      - "26381:26379"
    # 网络配置
    networks:
      - redis-net
    # 数据卷挂载
    volumes:
      # 挂载 Sentinel 数据目录
      - sentinel3-data:/data
    # 依赖关系，确保 Redis 主节点先启动
    depends_on:
      redis-master:
        condition: service_healthy
    # Sentinel 启动命令参数
    command: >
      sh -c "
        echo 'port 26379' > /tmp/sentinel.conf &&
        echo 'dir /data' >> /tmp/sentinel.conf &&
        echo 'sentinel monitor mymaster localhost 6379 2' >> /tmp/sentinel.conf &&
        echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
        echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
        echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
        echo 'sentinel resolve-hostnames yes' >> /tmp/sentinel.conf &&
        echo 'sentinel auth-pass mymaster root' >> /tmp/sentinel.conf &&
        redis-sentinel /tmp/sentinel.conf
      "
    healthcheck:
      test: [ "CMD", "redis-cli", "-p", "26379", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# 数据卷定义
volumes:
  # MySQL 数据卷
  mysql-data:
  # Redis 主节点数据卷
  redis_master_data:
  # Redis 从节点1数据卷
  redis_slave1_data:
  # Redis 从节点2数据卷
  redis_slave2_data:
  # Sentinel 1 数据卷
  sentinel1-data:
  # Sentinel 2 数据卷
  sentinel2-data:
  # Sentinel 3 数据卷
  sentinel3-data:

# 网络定义
networks:
  # 自定义网络
  redis-net:
    # 网络驱动
    driver: bridge